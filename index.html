<script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQhLTr6y6uUfZFSRcf8rHz_QA0gv_Yoc6ojmRi0TEubRjXk1mLWIiQO5cz130i7JtscZtcWVBPUhMSq/pub?output=csv';
    const canvas = document.getElementById('cardCanvas');
    const ctx = canvas.getContext('2d');

    async function checkMember() {
        const input = document.getElementById('memberSearch').value.trim().toLowerCase();
        if(!input) return;
        const response = await fetch(csvUrl);
        const data = await response.text();
        const rows = data.split('\n').map(row => row.split(','));
        const member = rows.find(r => r[2]?.trim().toLowerCase() === input || r[7]?.trim().toLowerCase() === input);

        if (member && member[6]?.trim() === 'Activo') {
            document.getElementById('resultArea').classList.remove('hidden');
            drawCard(member);
            if (member[5]?.trim() === 'Explorer') {
                document.getElementById('discountZone').classList.remove('hidden');
            } else {
                document.getElementById('discountZone').classList.add('hidden');
            }
        } else {
            alert("Miembro no encontrado o pendiente de activación.");
        }
    }

    function drawCard(m) {
        const template = new Image();
        template.src = (m[5]?.trim() === 'Explorer') ? 'TEMPLATE_VIP_CARD.png' : 'TEMPLATE_AVX_CARDCLUB.png';
        template.onload = function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(template, 0, 0, 1000, 600);
            
            // QR UBICADO MÁS ARRIBA (Para liberar la web inferior)
            const qrImg = new Image();
            qrImg.crossOrigin = "anonymous";
            qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=VALID_AVX_${m[7]}`;
            qrImg.onload = () => {
                ctx.fillStyle = "rgba(255,255,255,0.85)";
                ctx.fillRect(780, 250, 170, 170); // Caja blanca subida
                ctx.drawImage(qrImg, 790, 260, 150, 150); // QR subido
            };

            // 1. NOMBRE (Blanco, Bold)
            ctx.fillStyle = "white";
            ctx.font = "bold 42px Montserrat";
            ctx.fillText(`${m[0]} ${m[1]}`, 560, 140);
            
            // 2. ID DE MIEMBRO (EL MÁS DESTACADO - Amarillo, Bold)
            ctx.fillStyle = "#FFCD00";
            ctx.font = "bold 48px Montserrat";
            ctx.fillText(`ID: ${m[7]}`, 560, 210);
            
            // 3. PAÍS (Blanco, Normal)
            ctx.fillStyle = "white";
            ctx.font = "24px Montserrat";
            ctx.fillText(`País: ${m[3]}`, 560, 260);
            
            // 4. FECHA VENCIMIENTO (Blanco, Más pequeño, Sin Bold)
            ctx.font = "20px Montserrat";
            ctx.fillText(`Vence: ${m[9]}`, 560, 300);
        }
    }
</script>
